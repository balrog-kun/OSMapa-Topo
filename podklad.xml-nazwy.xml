<Layer name="punkty">
  <StyleName>punkty</StyleName>
  <Datasource>
    &datasource-settings;
    <Parameter name="table">planet_osm_point</Parameter>
    <Parameter name="geometry_field">way</Parameter>
  </Datasource>
</Layer>

<Layer name="punkty_na_poligonach">
  <StyleName>punkty_na_poligonach</StyleName>
  <Datasource>
    &datasource-settings;
    <Parameter name="table">planet_osm_polygon</Parameter>
    <Parameter name="geometry_field">way</Parameter>
  </Datasource>
</Layer>

<Layer name="nazwy_poligonow_lores">
  <StyleName>nazwy_poligonow_lores</StyleName>
  <Datasource>
    &datasource-settings;
    <Parameter name="table">(SELECT way, name FROM countries WHERE way &amp;&amp; !bbox! ORDER BY population DESC NULLS LAST) AS "miejsca"</Parameter>
    <Parameter name="geometry_field">way</Parameter>
  </Datasource>
</Layer>

<Layer name="nazwy_poligonow">
  <StyleName>nazwy_poligonow</StyleName>
  <Datasource>
    &datasource-settings;
    <Parameter name="table">planet_osm_polygon</Parameter>
    <Parameter name="geometry_field">way</Parameter>
  </Datasource>
</Layer>

<Layer name="refy_drog">
  <StyleName>refy_drog</StyleName>
  <Datasource>
    &datasource-settings;
    <Parameter name="table">
(SELECT way, highway,
   (SELECT MAX(CASE WHEN char_length(r) > 7 THEN 3 ELSE
      CASE WHEN char_length(r) > 3 THEN 2 ELSE 1 END END)
    FROM unnest(refs) AS r) AS width,
   LEAST(array_length(refs, 1), 3) AS height,
   array_to_string(refs, E'\n') AS refs -- TODO: sort
 FROM
   (SELECT ST_LineMerge(ST_Collect(way)) AS way, highway,
      string_to_array(replace(ref, ' ', ''), ';') AS refs
    FROM planet_osm_line
    WHERE ref IS NOT NULL AND highway IS NOT NULL AND
      way &amp;&amp; !bbox! -- ST_Expand(!bbox!, 500)
    GROUP BY highway, ref
    ORDER BY highway NOT IN ('trunk', 'motorway', 'primary')
   ) AS z) AS "refy_drog"</Parameter>
    <Parameter name="geometry_field">way</Parameter>
  </Datasource>
</Layer>

<Layer name="nazwy_drog">
  <StyleName>nazwy_drog</StyleName>
  <Datasource>
    &datasource-settings;
    <Parameter name="table">
(SELECT ST_LineMerge(ST_Collect(way)) AS way, highway, waterway, name,
   min(short_name) AS short_name, min(shortest_name) AS shortest_name
 FROM planet_osm_line
 WHERE name IS NOT NULL AND
   (highway IS NOT NULL OR waterway IS NOT NULL) AND
    way &amp;&amp; ST_Expand(!bbox!, 500)
  GROUP BY name, highway, waterway
  ORDER BY highway NOT IN ('trunk', 'motorway', 'primary'),
    highway &lt;&gt; 'secondary', highway &lt;&gt; 'tertiary'
 ) AS "nazwy_drog"</Parameter>
    <!-- TODO: ORDER BY ST_Length(output.way) too -->
    <Parameter name="geometry_field">way</Parameter>
  </Datasource>
</Layer>

<Layer name="oneway_drog">
  <StyleName>oneway_drog</StyleName>
  <Datasource>
    &datasource-settings;
    <Parameter name="table">(SELECT way FROM planet_osm_line WHERE oneway IN ('1', 'yes', 'true') AND highway IS NOT NULL) AS "oneway_drog"</Parameter>
    <Parameter name="geometry_field">way</Parameter>
  </Datasource>
</Layer>

<Layer name="nazwy_miast" clear-label-cache="on">
  <StyleName>nazwy_miast</StyleName>
  <Datasource>
    &datasource-settings;
    <Parameter name="table">(SELECT way, name, short_name, shortest_name, population, place, capital, admin_level FROM planet_osm_point WHERE way &amp;&amp; !bbox! AND (place = 'city' OR place = 'town') ORDER BY place ASC, population DESC NULLS LAST) AS "miejsca"</Parameter>
    <Parameter name="geometry_field">way</Parameter>
  </Datasource>
</Layer>

<Layer name="nazwy_miejsc" clear-label-cache="on">
  <StyleName>nazwy_miejsc</StyleName>
  <Datasource>
    &datasource-settings;
    <Parameter name="table">(SELECT way, name, short_name, shortest_name, population, place, capital, admin_level FROM planet_osm_point WHERE way &amp;&amp; !bbox! AND place IS NOT NULL ORDER BY place &lt;&gt; 'city' ASC, place &lt;&gt; 'town' ASC, place &lt;&gt; 'suburb' ASC, place &lt;&gt; 'village' ASC, population DESC NULLS LAST) as "miejsca"</Parameter>
    <Parameter name="geometry_field">way</Parameter>
  </Datasource>
</Layer>
